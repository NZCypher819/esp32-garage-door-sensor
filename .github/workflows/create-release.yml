name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      changelog:
        description: 'Release changelog'
        required: false
        type: string
        default: 'Bug fixes and improvements'

permissions:
  contents: write
  actions: read

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Validate version format
      run: |
        if [[ ! "${{ inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "Error: Version must be in format v1.2.3"
          exit 1
        fi
        
    - name: Update firmware version in code
      run: |
        # Create a temporary version file for this build
        echo "${{ inputs.version }}" > VERSION.txt
        
        # Update version in ota_config.h for this build only
        sed -i 's/#define FIRMWARE_VERSION ".*"/#define FIRMWARE_VERSION "${{ inputs.version }}"/' include/ota_config.h
        
        # Update version in main web page for this build only
        sed -i 's/"version": ".*"/"version": "${{ inputs.version }}"/' src/web_server.cpp
        
    - name: Show version changes
      run: |
        echo "Updated firmware version to ${{ inputs.version }}"
        grep "FIRMWARE_VERSION" include/ota_config.h
        grep '"version":' src/web_server.cpp | head -1
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ inputs.version }}
        release_name: ESP32 Garage Door Sensor ${{ inputs.version }}
        body: |
          ## ESP32 Garage Door Sensor Release ${{ inputs.version }}
          
          ### üöÄ Features
          - E3JK-RR11 photoelectric sensor support
          - Real-time web dashboard monitoring
          - WiFi connectivity with secure credential management
          - Over-the-air (OTA) firmware updates
          - Simulation mode for testing without hardware
          - Mobile-responsive web interface
          
          ### üì¶ Installation
          1. Download `esp32-garage-door-firmware-${{ inputs.version }}.bin`
          2. Flash to your ESP32 S3 Nano using:
             - **PlatformIO**: `pio run -t upload`
             - **Arduino IDE**: Tools ‚Üí Port ‚Üí Upload
             - **Web OTA**: Access existing device web interface at `/update`
          
          ### üîß Configuration
          1. Copy `include/secrets.h.template` to `include/secrets.h`
          2. Update WiFi credentials in `secrets.h`
          3. Compile and upload firmware
          
          ### üåê OTA Updates
          After flashing this firmware, future updates can be installed:
          - **Network OTA**: Via Arduino IDE/PlatformIO over WiFi
          - **Web OTA**: Visit `http://[device-ip]/update` (admin/GarageDoor2025)
          - **Automatic**: Device checks for updates every 60 seconds
          
          ### üìã Changelog
          ${{ inputs.changelog }}
          
          ### üîí Security Notes
          - Change default OTA password in `ota_config.h`
          - Secure your WiFi network
          - Keep firmware updated
          
          ---
          **Built on:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
          **Commit:** ${{ github.sha }}  
          **Firmware Size:** ~1MB (30% flash usage)  
          **Memory Usage:** ~51KB RAM (15% usage)
        draft: false
        prerelease: false
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
        
    - name: Create secrets.h for build
      run: |
        cp include/secrets.h.template include/secrets.h
        sed -i 's/YOUR_WIFI_SSID_HERE/RELEASE_BUILD/' include/secrets.h
        sed -i 's/YOUR_WIFI_PASSWORD_HERE/RELEASE_BUILD/' include/secrets.h
        
    - name: Build release firmware
      run: |
        platformio run --environment esp32-s3-devkitc-1
        
    - name: Upload firmware binary
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: .pio/build/esp32-s3-devkitc-1/firmware.bin
        asset_name: esp32-garage-door-firmware-${{ inputs.version }}.bin
        asset_content_type: application/octet-stream