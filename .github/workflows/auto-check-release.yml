name: Auto Check and Release

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual triggering
    
permissions:
  contents: write
  actions: read

jobs:
  check-for-changes:
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.check-changes.outputs.should-release }}
      version: ${{ steps.check-changes.outputs.version }}
      changelog: ${{ steps.check-changes.outputs.changelog }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Get latest release
      id: get-latest
      run: |
        # Get the latest release tag, default to v0.0.0 if none exist
        LATEST_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "v0.0.0")
        echo "latest-tag=$LATEST_TAG" >> $GITHUB_OUTPUT
        echo "Latest release: $LATEST_TAG"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Check for significant changes since last release
      id: check-changes
      run: |
        LATEST_TAG="${{ steps.get-latest.outputs.latest-tag }}"
        
        # If no releases exist, check last 7 days of commits
        if [ "$LATEST_TAG" = "v0.0.0" ]; then
          SINCE_DATE=$(date -d '7 days ago' '+%Y-%m-%d')
          COMMITS=$(git log --since="$SINCE_DATE" --oneline --no-merges)
        else
          # Check commits since last release
          COMMITS=$(git log ${LATEST_TAG}..HEAD --oneline --no-merges 2>/dev/null || echo "")
        fi
        
        if [ -z "$COMMITS" ]; then
          echo "No new commits found"
          echo "should-release=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "Found new commits:"
        echo "$COMMITS"
        
        # Check if changes are significant enough for a release
        SIGNIFICANT_CHANGES=$(echo "$COMMITS" | grep -iE "(fix|feat|add|update|improve|security|bug)" || echo "")
        
        if [ -z "$SIGNIFICANT_CHANGES" ]; then
          echo "No significant changes found"
          echo "should-release=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Generate new version number
        if [ "$LATEST_TAG" = "v0.0.0" ]; then
          NEW_VERSION="v1.0.0"
        else
          # Extract version numbers
          MAJOR=$(echo $LATEST_TAG | sed 's/v//' | cut -d. -f1)
          MINOR=$(echo $LATEST_TAG | sed 's/v//' | cut -d. -f2)
          PATCH=$(echo $LATEST_TAG | sed 's/v//' | cut -d. -f3)
          
          # Check if changes are breaking/major
          if echo "$COMMITS" | grep -qi "breaking\|major"; then
            NEW_VERSION="v$((MAJOR + 1)).0.0"
          # Check if changes add new features
          elif echo "$COMMITS" | grep -qi "feat\|add\|new"; then
            NEW_VERSION="v${MAJOR}.$((MINOR + 1)).0"
          # Otherwise, it's a patch release
          else
            NEW_VERSION="v${MAJOR}.${MINOR}.$((PATCH + 1))"
          fi
        fi
        
        # Generate changelog
        CHANGELOG=$(echo "$COMMITS" | sed 's/^[a-f0-9]* /- /' | head -10)
        CHANGELOG="## What's Changed\n\n$CHANGELOG\n\n**Full Changelog**: https://github.com/${{ github.repository }}/compare/${LATEST_TAG}...${NEW_VERSION}"
        
        echo "should-release=true" >> $GITHUB_OUTPUT
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "Would create release: $NEW_VERSION"
        
    - name: Check if release already exists
      if: steps.check-changes.outputs.should-release == 'true'
      run: |
        VERSION="${{ steps.check-changes.outputs.version }}"
        
        # Check if this version already exists
        if gh release view "$VERSION" >/dev/null 2>&1; then
          echo "Release $VERSION already exists, skipping"
          echo "should-release=false" >> $GITHUB_OUTPUT
        else
          echo "Release $VERSION does not exist, proceeding"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  auto-release:
    needs: check-for-changes
    if: needs.check-for-changes.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update firmware version in code
      run: |
        VERSION="${{ needs.check-for-changes.outputs.version }}"
        
        # Update version in ota_config.h
        sed -i "s/#define FIRMWARE_VERSION \".*\"/#define FIRMWARE_VERSION \"$VERSION\"/" include/ota_config.h
        
        # Update version in main web page
        sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" src/web_server.cpp
        
        echo "Updated firmware version to $VERSION"
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
        
    - name: Create secrets.h for build
      run: |
        cp include/secrets.h.template include/secrets.h
        sed -i 's/YOUR_WIFI_SSID_HERE/RELEASE_BUILD/' include/secrets.h
        sed -i 's/YOUR_WIFI_PASSWORD_HERE/RELEASE_BUILD/' include/secrets.h
        
    - name: Build release firmware
      run: |
        platformio run --environment esp32-s3-devkitc-1
        
    - name: Create release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ needs.check-for-changes.outputs.version }}"
        CHANGELOG="${{ needs.check-for-changes.outputs.changelog }}"
        
        # Create the release
        gh release create "$VERSION" \
          --title "ESP32 Garage Door Sensor $VERSION" \
          --notes "$CHANGELOG" \
          --latest
        
        # Upload firmware binary
        gh release upload "$VERSION" \
          .pio/build/esp32-s3-devkitc-1/firmware.bin#firmware.bin \
          --clobber
        
        echo "âœ… Auto-released version $VERSION"

  notify-success:
    needs: [check-for-changes, auto-release]
    if: needs.check-for-changes.outputs.should-release == 'true' && success()
    runs-on: ubuntu-latest
    
    steps:
    - name: Log successful auto-release
      run: |
        echo "ðŸŽ‰ Successfully auto-released ${{ needs.check-for-changes.outputs.version }}"
        echo "Release available at: https://github.com/${{ github.repository }}/releases/tag/${{ needs.check-for-changes.outputs.version }}"